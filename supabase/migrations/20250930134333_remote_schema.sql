revoke delete on table "public"."answer_submissions" from "anon";

revoke insert on table "public"."answer_submissions" from "anon";

revoke references on table "public"."answer_submissions" from "anon";

revoke select on table "public"."answer_submissions" from "anon";

revoke trigger on table "public"."answer_submissions" from "anon";

revoke truncate on table "public"."answer_submissions" from "anon";

revoke update on table "public"."answer_submissions" from "anon";

revoke delete on table "public"."answer_submissions" from "authenticated";

revoke insert on table "public"."answer_submissions" from "authenticated";

revoke references on table "public"."answer_submissions" from "authenticated";

revoke select on table "public"."answer_submissions" from "authenticated";

revoke trigger on table "public"."answer_submissions" from "authenticated";

revoke truncate on table "public"."answer_submissions" from "authenticated";

revoke update on table "public"."answer_submissions" from "authenticated";

revoke delete on table "public"."answer_submissions" from "service_role";

revoke insert on table "public"."answer_submissions" from "service_role";

revoke references on table "public"."answer_submissions" from "service_role";

revoke select on table "public"."answer_submissions" from "service_role";

revoke trigger on table "public"."answer_submissions" from "service_role";

revoke truncate on table "public"."answer_submissions" from "service_role";

revoke update on table "public"."answer_submissions" from "service_role";

revoke delete on table "public"."game_questions" from "anon";

revoke insert on table "public"."game_questions" from "anon";

revoke references on table "public"."game_questions" from "anon";

revoke select on table "public"."game_questions" from "anon";

revoke trigger on table "public"."game_questions" from "anon";

revoke truncate on table "public"."game_questions" from "anon";

revoke update on table "public"."game_questions" from "anon";

revoke delete on table "public"."game_questions" from "authenticated";

revoke insert on table "public"."game_questions" from "authenticated";

revoke references on table "public"."game_questions" from "authenticated";

revoke select on table "public"."game_questions" from "authenticated";

revoke trigger on table "public"."game_questions" from "authenticated";

revoke truncate on table "public"."game_questions" from "authenticated";

revoke update on table "public"."game_questions" from "authenticated";

revoke delete on table "public"."game_questions" from "service_role";

revoke insert on table "public"."game_questions" from "service_role";

revoke references on table "public"."game_questions" from "service_role";

revoke select on table "public"."game_questions" from "service_role";

revoke trigger on table "public"."game_questions" from "service_role";

revoke truncate on table "public"."game_questions" from "service_role";

revoke update on table "public"."game_questions" from "service_role";

revoke delete on table "public"."games" from "anon";

revoke insert on table "public"."games" from "anon";

revoke references on table "public"."games" from "anon";

revoke select on table "public"."games" from "anon";

revoke trigger on table "public"."games" from "anon";

revoke truncate on table "public"."games" from "anon";

revoke update on table "public"."games" from "anon";

revoke delete on table "public"."games" from "authenticated";

revoke insert on table "public"."games" from "authenticated";

revoke references on table "public"."games" from "authenticated";

revoke select on table "public"."games" from "authenticated";

revoke trigger on table "public"."games" from "authenticated";

revoke truncate on table "public"."games" from "authenticated";

revoke update on table "public"."games" from "authenticated";

revoke delete on table "public"."games" from "service_role";

revoke insert on table "public"."games" from "service_role";

revoke references on table "public"."games" from "service_role";

revoke select on table "public"."games" from "service_role";

revoke trigger on table "public"."games" from "service_role";

revoke truncate on table "public"."games" from "service_role";

revoke update on table "public"."games" from "service_role";

revoke delete on table "public"."hosts" from "anon";

revoke insert on table "public"."hosts" from "anon";

revoke references on table "public"."hosts" from "anon";

revoke select on table "public"."hosts" from "anon";

revoke trigger on table "public"."hosts" from "anon";

revoke truncate on table "public"."hosts" from "anon";

revoke update on table "public"."hosts" from "anon";

revoke delete on table "public"."hosts" from "authenticated";

revoke insert on table "public"."hosts" from "authenticated";

revoke references on table "public"."hosts" from "authenticated";

revoke select on table "public"."hosts" from "authenticated";

revoke trigger on table "public"."hosts" from "authenticated";

revoke truncate on table "public"."hosts" from "authenticated";

revoke update on table "public"."hosts" from "authenticated";

revoke delete on table "public"."hosts" from "service_role";

revoke insert on table "public"."hosts" from "service_role";

revoke references on table "public"."hosts" from "service_role";

revoke select on table "public"."hosts" from "service_role";

revoke trigger on table "public"."hosts" from "service_role";

revoke truncate on table "public"."hosts" from "service_role";

revoke update on table "public"."hosts" from "service_role";

revoke delete on table "public"."leaderboard_cache" from "anon";

revoke insert on table "public"."leaderboard_cache" from "anon";

revoke references on table "public"."leaderboard_cache" from "anon";

revoke select on table "public"."leaderboard_cache" from "anon";

revoke trigger on table "public"."leaderboard_cache" from "anon";

revoke truncate on table "public"."leaderboard_cache" from "anon";

revoke update on table "public"."leaderboard_cache" from "anon";

revoke delete on table "public"."leaderboard_cache" from "authenticated";

revoke insert on table "public"."leaderboard_cache" from "authenticated";

revoke references on table "public"."leaderboard_cache" from "authenticated";

revoke select on table "public"."leaderboard_cache" from "authenticated";

revoke trigger on table "public"."leaderboard_cache" from "authenticated";

revoke truncate on table "public"."leaderboard_cache" from "authenticated";

revoke update on table "public"."leaderboard_cache" from "authenticated";

revoke delete on table "public"."leaderboard_cache" from "service_role";

revoke insert on table "public"."leaderboard_cache" from "service_role";

revoke references on table "public"."leaderboard_cache" from "service_role";

revoke select on table "public"."leaderboard_cache" from "service_role";

revoke trigger on table "public"."leaderboard_cache" from "service_role";

revoke truncate on table "public"."leaderboard_cache" from "service_role";

revoke update on table "public"."leaderboard_cache" from "service_role";

revoke delete on table "public"."player_profiles" from "anon";

revoke insert on table "public"."player_profiles" from "anon";

revoke references on table "public"."player_profiles" from "anon";

revoke select on table "public"."player_profiles" from "anon";

revoke trigger on table "public"."player_profiles" from "anon";

revoke truncate on table "public"."player_profiles" from "anon";

revoke update on table "public"."player_profiles" from "anon";

revoke delete on table "public"."player_profiles" from "authenticated";

revoke insert on table "public"."player_profiles" from "authenticated";

revoke references on table "public"."player_profiles" from "authenticated";

revoke select on table "public"."player_profiles" from "authenticated";

revoke trigger on table "public"."player_profiles" from "authenticated";

revoke truncate on table "public"."player_profiles" from "authenticated";

revoke update on table "public"."player_profiles" from "authenticated";

revoke delete on table "public"."player_profiles" from "service_role";

revoke insert on table "public"."player_profiles" from "service_role";

revoke references on table "public"."player_profiles" from "service_role";

revoke select on table "public"."player_profiles" from "service_role";

revoke trigger on table "public"."player_profiles" from "service_role";

revoke truncate on table "public"."player_profiles" from "service_role";

revoke update on table "public"."player_profiles" from "service_role";

revoke delete on table "public"."question_usage" from "anon";

revoke insert on table "public"."question_usage" from "anon";

revoke references on table "public"."question_usage" from "anon";

revoke select on table "public"."question_usage" from "anon";

revoke trigger on table "public"."question_usage" from "anon";

revoke truncate on table "public"."question_usage" from "anon";

revoke update on table "public"."question_usage" from "anon";

revoke delete on table "public"."question_usage" from "authenticated";

revoke insert on table "public"."question_usage" from "authenticated";

revoke references on table "public"."question_usage" from "authenticated";

revoke select on table "public"."question_usage" from "authenticated";

revoke trigger on table "public"."question_usage" from "authenticated";

revoke truncate on table "public"."question_usage" from "authenticated";

revoke update on table "public"."question_usage" from "authenticated";

revoke delete on table "public"."question_usage" from "service_role";

revoke insert on table "public"."question_usage" from "service_role";

revoke references on table "public"."question_usage" from "service_role";

revoke select on table "public"."question_usage" from "service_role";

revoke trigger on table "public"."question_usage" from "service_role";

revoke truncate on table "public"."question_usage" from "service_role";

revoke update on table "public"."question_usage" from "service_role";

revoke delete on table "public"."questions" from "anon";

revoke insert on table "public"."questions" from "anon";

revoke references on table "public"."questions" from "anon";

revoke select on table "public"."questions" from "anon";

revoke trigger on table "public"."questions" from "anon";

revoke truncate on table "public"."questions" from "anon";

revoke update on table "public"."questions" from "anon";

revoke delete on table "public"."questions" from "authenticated";

revoke insert on table "public"."questions" from "authenticated";

revoke references on table "public"."questions" from "authenticated";

revoke select on table "public"."questions" from "authenticated";

revoke trigger on table "public"."questions" from "authenticated";

revoke truncate on table "public"."questions" from "authenticated";

revoke update on table "public"."questions" from "authenticated";

revoke delete on table "public"."questions" from "service_role";

revoke insert on table "public"."questions" from "service_role";

revoke references on table "public"."questions" from "service_role";

revoke select on table "public"."questions" from "service_role";

revoke trigger on table "public"."questions" from "service_role";

revoke truncate on table "public"."questions" from "service_role";

revoke update on table "public"."questions" from "service_role";

revoke delete on table "public"."rounds" from "anon";

revoke insert on table "public"."rounds" from "anon";

revoke references on table "public"."rounds" from "anon";

revoke select on table "public"."rounds" from "anon";

revoke trigger on table "public"."rounds" from "anon";

revoke truncate on table "public"."rounds" from "anon";

revoke update on table "public"."rounds" from "anon";

revoke delete on table "public"."rounds" from "authenticated";

revoke insert on table "public"."rounds" from "authenticated";

revoke references on table "public"."rounds" from "authenticated";

revoke select on table "public"."rounds" from "authenticated";

revoke trigger on table "public"."rounds" from "authenticated";

revoke truncate on table "public"."rounds" from "authenticated";

revoke update on table "public"."rounds" from "authenticated";

revoke delete on table "public"."rounds" from "service_role";

revoke insert on table "public"."rounds" from "service_role";

revoke references on table "public"."rounds" from "service_role";

revoke select on table "public"."rounds" from "service_role";

revoke trigger on table "public"."rounds" from "service_role";

revoke truncate on table "public"."rounds" from "service_role";

revoke update on table "public"."rounds" from "service_role";

revoke delete on table "public"."team_members" from "anon";

revoke insert on table "public"."team_members" from "anon";

revoke references on table "public"."team_members" from "anon";

revoke select on table "public"."team_members" from "anon";

revoke trigger on table "public"."team_members" from "anon";

revoke truncate on table "public"."team_members" from "anon";

revoke update on table "public"."team_members" from "anon";

revoke delete on table "public"."team_members" from "authenticated";

revoke insert on table "public"."team_members" from "authenticated";

revoke references on table "public"."team_members" from "authenticated";

revoke select on table "public"."team_members" from "authenticated";

revoke trigger on table "public"."team_members" from "authenticated";

revoke truncate on table "public"."team_members" from "authenticated";

revoke update on table "public"."team_members" from "authenticated";

revoke delete on table "public"."team_members" from "service_role";

revoke insert on table "public"."team_members" from "service_role";

revoke references on table "public"."team_members" from "service_role";

revoke select on table "public"."team_members" from "service_role";

revoke trigger on table "public"."team_members" from "service_role";

revoke truncate on table "public"."team_members" from "service_role";

revoke update on table "public"."team_members" from "service_role";

revoke delete on table "public"."teams" from "anon";

revoke insert on table "public"."teams" from "anon";

revoke references on table "public"."teams" from "anon";

revoke select on table "public"."teams" from "anon";

revoke trigger on table "public"."teams" from "anon";

revoke truncate on table "public"."teams" from "anon";

revoke update on table "public"."teams" from "anon";

revoke delete on table "public"."teams" from "authenticated";

revoke insert on table "public"."teams" from "authenticated";

revoke references on table "public"."teams" from "authenticated";

revoke select on table "public"."teams" from "authenticated";

revoke trigger on table "public"."teams" from "authenticated";

revoke truncate on table "public"."teams" from "authenticated";

revoke update on table "public"."teams" from "authenticated";

revoke delete on table "public"."teams" from "service_role";

revoke insert on table "public"."teams" from "service_role";

revoke references on table "public"."teams" from "service_role";

revoke select on table "public"."teams" from "service_role";

revoke trigger on table "public"."teams" from "service_role";

revoke truncate on table "public"."teams" from "service_role";

revoke update on table "public"."teams" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.count_available_questions(p_host_id uuid, p_categories text[])
 RETURNS TABLE(in_selected_categories integer, in_all_categories integer)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    (
      SELECT COUNT(*)::INT
      FROM questions q
      WHERE q.category = ANY(p_categories)
        AND q.id NOT IN (
          SELECT question_id FROM question_usage WHERE host_id = p_host_id
        )
    ) AS in_selected_categories,
    (
      SELECT COUNT(*)::INT
      FROM questions q
      WHERE q.id NOT IN (
        SELECT question_id FROM question_usage WHERE host_id = p_host_id
      )
    ) AS in_all_categories;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.refresh_game_history(p_game_id uuid)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY game_history;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.refresh_leaderboard()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY leaderboard_entries;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.select_questions_for_host(p_host_id uuid, p_categories text[], p_count integer)
 RETURNS TABLE(question_id uuid, category text, question text, answer_a text, answer_b text, answer_c text, answer_d text)
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_available_count INT;
  v_use_all_categories BOOLEAN := false;
BEGIN
  -- Count available questions in selected categories (excluding used questions)
  SELECT COUNT(*) INTO v_available_count
  FROM questions q
  WHERE q.category = ANY(p_categories)
    AND q.id NOT IN (
      SELECT question_id FROM question_usage WHERE host_id = p_host_id
    );

  -- If insufficient questions in selected categories, expand to all categories (FR-007)
  IF v_available_count < p_count THEN
    v_use_all_categories := true;

    -- Count available questions across all categories
    SELECT COUNT(*) INTO v_available_count
    FROM questions q
    WHERE q.id NOT IN (
      SELECT question_id FROM question_usage WHERE host_id = p_host_id
    );
  END IF;

  -- Return random selection of questions
  RETURN QUERY
  SELECT
    q.id,
    q.category,
    q.question,
    q.a,
    q.b,
    q.c,
    q.d
  FROM questions q
  WHERE
    (
      -- Either use selected categories or all categories
      CASE
        WHEN v_use_all_categories THEN true
        ELSE q.category = ANY(p_categories)
      END
    )
    AND q.id NOT IN (
      SELECT question_id FROM question_usage WHERE host_id = p_host_id
    )
  ORDER BY random()
  LIMIT p_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;



